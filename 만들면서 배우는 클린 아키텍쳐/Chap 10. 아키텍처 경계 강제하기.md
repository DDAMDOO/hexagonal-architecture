# Chap 10. 아키텍처 경계 강제하기



### 경계와 의존성

아키텍처를 경계한다는 것은 의존성이 올바른 방향을 향하도록 강제하는 것이다.

아키텍처의 경계는 각 계층 사이, 안쪽 인접 계층과 바깥쪽 인접 계층 사이에 경계가 있다. 의존성 규칙에 따르면 계층 경계를 넘는 의존성은 항상 안쪽 방향으로 향해야 한다.



### 접근 제한자

경계를 강제하기 위해 자바에서 제공하는 가장 기본적인 도구이다.

주로 public, protected, private을 많이 사용하지만 package-private를 이용하면 자바 패키지를 통해 클래스들을 **응집적인 모듈**로 만들어 주기에 중요하다. 이렇게 하면 의존성이 잘못된 방향을 가리켜서 의존성 규칙을 위반할 위험이 줄어든다.

> buckpal
>
> * account
>  * adapter
>    * in
>      * web
>        * ○ AccountController
>    * out
>      * persistence
>        * ○ AccountPersistenceAdapter
>        * ○ SpringDataAccountRepository
>  * domain
>    * \+ Account
>    * \+ Activity
>  * application
>    * ○ SendMoneyService
>    * port
>      * in
>        * \+ SendMoneyUsecase
>      * out
>        * \+ LoadAccountPort
>        * \+ UpdateAccountStatePort

3장에 있던 패키지 구조이다. 외부 접근이 필요없는 package-private은 위 트리에서 ○ 로 표시하였고, 나머지 클래스들은 +로 표시하였다.

영속성 패키지 클래스들과 SendMoneyService는 외부에서 접근할 필요가 없기 때문에 package-private으로 만들 수 있다. 나머지 클래스들은 아키텍처 정의에 의해 public이어야 한다.

package-private은 패키지 내의 클래스가 너무 많은 경우 혼란스러워지게 된다. 이렇게 되면 코드를 쉽게 찾기 위해 하위 패키지를 만드는 방법을 선호하는데 이 경우 하위 패키지는 다른 패키지로 인식하기 때문에 package-private으로 접근이 불가능하여 public으로 만들어 의존성 규칙이 깨질 수 있다.



### 컴파일 후 체크

클래스에 public 제한자를 쓰면 의존성 방향이 잘못되더라도 컴파일러는 다른 클래스들이 이 클래스를 사용하도록 하용한다. 그렇기 때문에 코드가 컴파일 된 후인 런타임에 체크하도록 해야 한다.

이러한 체크를 도와주는 자바용 도구로 `ArchUnit`이 있다. `ArchUnit`은 의존성 방향이 의도한대로 잘 설정되었는지 체크하는 API를 제공한다.

`ArchUnit API`를 이용하면 적은 작업으로 도메인 특화 언어를 만들 수 있고, 패키지 사이의 의존성 방향을 자동 체크할 수 있다.

컴파일 후 체크하는게 잘못된 의존성을 바로잡는데 도움은 되지만 실패에 안전하진 않기 때문에 언제나 코드와 함께 유지보수 되어야 한다.



### 빌드 아티팩트

빌드 아티팩트는 빌드 프로세스의 결과물이다. 자바에서는 최근 가장 인기있는 빌드 도구는 `Maven`과 `Gradle`이다. 

빌드 도구의 주요 기능 중 하나는 의존성 해결이다. 어떤 코드베이스를 빌드 아티팩트로 변환하기 위해 빌드도구는 코드베이스가 의존하고 있는 모든 아티팩트가 사용 가능한지 확인하고 이를 활용해서 모듈과 아키텍처의 계층간의 의존성을 강제할 수 있다.



#### 빌드 모듈로 아키텍처 경계를 구분하는 것의 장점

##### 1. 빌드 도구가 순환 의존성을 극도로 싫어한다.

* 빌드 도구를 사용하면 빌드 모듈 간 순환 의존성이 없음을 확신할 수 있다.

##### 2. 빌드 모듈 방식에서는 다른 모듈을 고려하지 않고 특정 모듈의 코드를 격리한 채로 변경할 수 있다.

##### 3. 모듈 간 의존성이 빌드 스크립트에 분명하게 선언돼 있기 때문에 새로 의존성을 추가하는 일은 우연이 아닌 의식적인 행동이 된다.



### 유지보수 가능한 소프트웨어를 만드는 데 어떻게 도움이 될까?

소프트웨어 아키텍처는 아키텍처 요소 간의 의존성을 관리하는 일이 전부다. 그렇기 때문에 아키텍처를 잘 유지하기 위해서는 의존성이 올바른 방향을 가리키고 있는지 지속적으로 확인해야 한다.

새로운 코드 추가나 리팩토링 시 패키지 구조를 염두해두어야 하고, 가능한 패키지 바깥에서 접근하면 안 되는 클래스에 대한 의존성을 `package-private`을 이용해서 피해야 한다. 만약 이러한 제한자를 사용할 수 없다면 `ArchUnit`과 같은 컴파일 후 체크 도구를 사용하면 된다.



## Q&A

#### spring initializer에서 설정을 했는데 이렇게 안하고 커스터마이징이 가능한가?

커스터마이징이라기보다는 각각의 모듈에 gradle을 달아서 사용이 가능하다?

각 모듈별로 build/libs 안에 jar로 패키징된다.



빌드아티펙트가 중요하긴 하지만 혼자하는 프로젝트가 아닌 팀원들과 함께하는 프로젝트의 경우 서로간의 약속이 더 중요하다. 리뷰단계에서 잘 잡는게 중요할 것 같다.



https://news.hada.io/topic?id=2665